# ğŸ“ Microsoft 365 ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†

## ğŸ“‹ æ¦‚è¦

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€æ•™è‚²æ©Ÿé–¢ã«ãŠã‘ã‚‹Microsoft 365ã®ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†ã«ã¤ã„ã¦è©³ã—ãèª¬æ˜ã—ã¾ã™ã€‚åŠ¹ç‡çš„ãªã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†ã€é©åˆ‡ãªæ¨©é™è¨­å®šã€ãã—ã¦æ•™è‚²ç¾å ´ã«é©ã—ãŸãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚

## ğŸ« æ•™è‚²æ©Ÿé–¢ã«ãŠã‘ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†ã®é‡è¦æ€§

### æ•™è‚²ç¾å ´ç‰¹æœ‰ã®èª²é¡Œ

æ•™è‚²æ©Ÿé–¢ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªç‰¹æœ‰ã®è¦ä»¶ãŒã‚ã‚Šã¾ã™ã€‚

- **å­¦å¹´ãƒ»ã‚¯ãƒ©ã‚¹å˜ä½**ã§ã®çµ„ç¹”ç®¡ç†
- **æ•™ç§‘ãƒ»éƒ¨æ´»å‹•**ã§ã®æ¨ªæ–­çš„ãªã‚°ãƒ«ãƒ¼ãƒ—
- **å­¦æœŸãƒ»å¹´åº¦**ã§ã®å®šæœŸçš„ãªãƒ¡ãƒ³ãƒãƒ¼å¤‰æ›´
- **æ•™å“¡ãƒ»ç”Ÿå¾’ãƒ»ä¿è­·è€…**ã®ç•°ãªã‚‹æ¨©é™ãƒ¬ãƒ™ãƒ«
- **å€‹äººæƒ…å ±ä¿è­·**ã®å³æ ¼ãªç®¡ç†è¦ä»¶

### Microsoft 365ã‚°ãƒ«ãƒ¼ãƒ—ã®æ•™è‚²çš„ä¾¡å€¤

- **å”åƒå­¦ç¿’ã®ä¿ƒé€²**ï¼šãƒãƒ¼ãƒ ã§ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæ¥­
- **æƒ…å ±å…±æœ‰ã®åŠ¹ç‡åŒ–**ï¼šã‚¯ãƒ©ã‚¹ãƒ»å­¦å¹´é–“ã§ã®é€£çµ¡äº‹é …
- **ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†**ï¼šæ•™æãƒ»èª²é¡Œã®é…å¸ƒã¨å›å
- **ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³å¼·åŒ–**ï¼šæ•™å“¡é–“ãƒ»ä¿è­·è€…ã¨ã®é€£æº

## ğŸ” Microsoft 365ã‚°ãƒ«ãƒ¼ãƒ—ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½¿ã„åˆ†ã‘

### Microsoft 365ã‚°ãƒ«ãƒ¼ãƒ—

#### ğŸ“‹ ç‰¹å¾´
- **çµ±åˆã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹**ï¼šTeamsã€SharePointã€Exchangeã€OneNoteãŒè‡ªå‹•çš„ã«ä½œæˆ
- **ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é‡è¦–**ï¼šå…±åŒä½œæ¥­ã¨ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒä¸»ç›®çš„
- **å‹•çš„ãªãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—**ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªç”±ã«å‚åŠ ãƒ»è„±é€€å¯èƒ½ï¼ˆè¨­å®šã«ã‚ˆã‚Šåˆ¶é™å¯èƒ½ï¼‰
- **è±Šå¯Œãªæ©Ÿèƒ½**ï¼šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã€ãƒ•ã‚¡ã‚¤ãƒ«å…±æœ‰ã€ä¼šè©±

#### ğŸ“ æ•™è‚²æ©Ÿé–¢ã§ã®æ´»ç”¨ä¾‹

```
ã€ã‚¯ãƒ©ã‚¹é‹å–¶ã€‘
- ã‚¯ãƒ©ã‚¹ç”¨Microsoft 365ã‚°ãƒ«ãƒ¼ãƒ—
  â””â”€â”€ Teams: æˆæ¥­ãƒ»HR
  â””â”€â”€ SharePoint: æ•™æãƒ»èª²é¡Œ
  â””â”€â”€ Exchange: é€£çµ¡äº‹é …
  â””â”€â”€ OneNote: ã‚¯ãƒ©ã‚¹ãƒãƒ¼ãƒˆ

ã€æ•™ç§‘æŒ‡å°ã€‘
- æ•°å­¦ç§‘Microsoft 365ã‚°ãƒ«ãƒ¼ãƒ—
  â””â”€â”€ Teams: æ•™ç§‘ä¼šè­°
  â””â”€â”€ SharePoint: æŒ‡å°æ¡ˆãƒ»æ•™æ
  â””â”€â”€ Exchange: æ•™ç§‘é€£çµ¡
  â””â”€â”€ OneNote: æˆæ¥­è¨˜éŒ²

ã€éƒ¨æ´»å‹•ãƒ»å§”å“¡ä¼šã€‘
- ç”Ÿå¾’ä¼šMicrosoft 365ã‚°ãƒ«ãƒ¼ãƒ—
  â””â”€â”€ Teams: ä¼šè­°ãƒ»æ‰“åˆã›
  â””â”€â”€ SharePoint: è³‡æ–™ãƒ»è­°äº‹éŒ²
  â””â”€â”€ Exchange: æ´»å‹•é€£çµ¡
  â””â”€â”€ OneNote: æ´»å‹•è¨˜éŒ²
```

#### âš™ï¸ ä½œæˆã¨è¨­å®šä¾‹

```powershell
# ã‚¯ãƒ©ã‚¹ç”¨Microsoft 365ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ
Connect-MgGraph -Scopes "Group.ReadWrite.All"

$groupParams = @{
    DisplayName = "3å¹´Açµ„ - 2024å¹´åº¦"
    MailNickname = "class-3a-2024"
    Description = "3å¹´Açµ„ã®ã‚¯ãƒ©ã‚¹é‹å–¶ç”¨ã‚°ãƒ«ãƒ¼ãƒ—"
    GroupTypes = @("Unified")
    MailEnabled = $true
    SecurityEnabled = $false
    Visibility = "Private"
}

$group = New-MgGroup @groupParams

# ãƒãƒ¼ãƒ æ©Ÿèƒ½ã®æœ‰åŠ¹åŒ–
$teamParams = @{
    "template@odata.bind" = "https://graph.microsoft.com/v1.0/teamsTemplates('educationClass')"
    DisplayName = "3å¹´Açµ„ - 2024å¹´åº¦"
    Description = "3å¹´Açµ„ã®ã‚¯ãƒ©ã‚¹é‹å–¶ç”¨ãƒãƒ¼ãƒ "
}

New-MgTeam -GroupId $group.Id -BodyParameter $teamParams
```

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—

#### ğŸ“‹ ç‰¹å¾´
- **ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡å°‚ç”¨**ï¼šãƒªã‚½ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ç®¡ç†ãŒä¸»ç›®çš„
- **ã‚·ãƒ³ãƒ—ãƒ«ãªæ§‹é€ **ï¼šãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã®ã¿
- **é«˜ã„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**ï¼šç®¡ç†è€…ã«ã‚ˆã‚‹ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†
- **ã‚·ã‚¹ãƒ†ãƒ çµ±åˆ**ï¼šã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ADã¨ã®åŒæœŸå¯èƒ½

#### ğŸ” æ•™è‚²æ©Ÿé–¢ã§ã®æ´»ç”¨ä¾‹

```
ã€è·ç¨®åˆ¥ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã€‘
- æ•™å“¡ã‚°ãƒ«ãƒ¼ãƒ—
  â””â”€â”€ æˆç¸¾ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚¯ã‚»ã‚¹
  â””â”€â”€ æ•™å‹™ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚¯ã‚»ã‚¹
  â””â”€â”€ è·å“¡å®¤SharePointã‚¢ã‚¯ã‚»ã‚¹

- äº‹å‹™è·å“¡ã‚°ãƒ«ãƒ¼ãƒ—
  â””â”€â”€ äººäº‹ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚¯ã‚»ã‚¹
  â””â”€â”€ è²¡å‹™ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚¯ã‚»ã‚¹
  â””â”€â”€ äº‹å‹™å®¤SharePointã‚¢ã‚¯ã‚»ã‚¹

ã€å­¦å¹´åˆ¥ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã€‘
- 1å¹´ç”Ÿã‚°ãƒ«ãƒ¼ãƒ—
  â””â”€â”€ 1å¹´ç”Ÿç”¨æ•™æã‚¢ã‚¯ã‚»ã‚¹
  â””â”€â”€ 1å¹´ç”Ÿç”¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

- 3å¹´ç”Ÿã‚°ãƒ«ãƒ¼ãƒ—
  â””â”€â”€ é€²è·¯æƒ…å ±ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚¯ã‚»ã‚¹
  â””â”€â”€ 3å¹´ç”Ÿå°‚ç”¨ãƒªã‚½ãƒ¼ã‚¹
```

#### âš™ï¸ ä½œæˆã¨è¨­å®šä¾‹

```powershell
# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ
$securityGroupParams = @{
    DisplayName = "æ•™å“¡_æˆç¸¾ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ _ã‚¢ã‚¯ã‚»ã‚¹"
    MailNickname = "teachers-gradebook-access"
    Description = "æˆç¸¾ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªæ•™å“¡"
    GroupTypes = @()
    MailEnabled = $false
    SecurityEnabled = $true
}

$secGroup = New-MgGroup @securityGroupParams

# ãƒ¡ãƒ³ãƒãƒ¼ã®è¿½åŠ 
$teacherIds = @(
    "teacher1@school.edu.jp",
    "teacher2@school.edu.jp"
)

foreach ($teacherId in $teacherIds) {
    $user = Get-MgUser -Filter "userPrincipalName eq '$teacherId'"
    New-MgGroupMember -GroupId $secGroup.Id -DirectoryObjectId $user.Id
}
```

### ğŸ¤” é¸æŠåŸºæº–

| ç”¨é€” | Microsoft 365ã‚°ãƒ«ãƒ¼ãƒ— | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ— |
|------|---------------------|-------------------|
| **ã‚¯ãƒ©ã‚¹é‹å–¶** | âœ… æ¨å¥¨ | âŒ |
| **æ•™ç§‘æŒ‡å°** | âœ… æ¨å¥¨ | âŒ |
| **éƒ¨æ´»å‹•ãƒ»å§”å“¡ä¼š** | âœ… æ¨å¥¨ | âŒ |
| **ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡** | âŒ | âœ… æ¨å¥¨ |
| **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ¨©é™** | âŒ | âœ… æ¨å¥¨ |
| **ä¸€æ™‚çš„ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ** | âœ… æ¨å¥¨ | âŒ |
| **æ’ä¹…çš„ãªè·ç¨®åˆ¥ç®¡ç†** | âŒ | âœ… æ¨å¥¨ |

## ğŸš« ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆæ¨©é™ã®åˆ¶é™

### ãªãœåˆ¶é™ãŒå¿…è¦ã‹

æ•™è‚²æ©Ÿé–¢ã§ã¯ä»¥ä¸‹ã®ç†ç”±ã§ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆæ¨©é™ã‚’åˆ¶é™ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š

- **ã‚¬ãƒãƒŠãƒ³ã‚¹å¼·åŒ–**ï¼šç„¡ç§©åºãªã‚°ãƒ«ãƒ¼ãƒ—å¢—åŠ ã®é˜²æ­¢
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç¢ºä¿**ï¼šä¸é©åˆ‡ãªæƒ…å ±å…±æœ‰ã®é˜²æ­¢
- **ç®¡ç†åŠ¹ç‡åŒ–**ï¼šç®¡ç†ã™ã¹ãã‚°ãƒ«ãƒ¼ãƒ—æ•°ã®é©æ­£åŒ–
- **ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹**ï¼šæ•™è‚²ãƒ‡ãƒ¼ã‚¿ä¿è­·æ³•ã¸ã®æº–æ‹ 

### åˆ¶é™ãƒ¬ãƒ™ãƒ«ã®è¨­å®š

#### ãƒ¬ãƒ™ãƒ«1ï¼šå®Œå…¨åˆ¶é™ï¼ˆæ¨å¥¨ï¼šå°ä¸­å­¦æ ¡ï¼‰
- **å¯¾è±¡**ï¼šå…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼
- **åˆ¶é™å†…å®¹**ï¼šMicrosoft 365ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆç¦æ­¢
- **ä½œæˆè€…**ï¼šITç®¡ç†è€…ã®ã¿

```powershell
# ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆæ¨©é™ã®å®Œå…¨åˆ¶é™
Connect-MgGraph -Scopes "Policy.ReadWrite.Authorization", "Directory.ReadWrite.All"

# ã‚°ãƒ«ãƒ¼ãƒ—è¨­å®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å–å¾—
$template = Get-MgDirectorySettingTemplate | Where-Object {$_.DisplayName -eq "Group.Unified"}

# è¨­å®šã®ä½œæˆ
$setting = @{
    TemplateId = $template.Id
    Values = @(
        @{
            Name = "EnableGroupCreation"
            Value = "false"
        }
    )
}

New-MgDirectorySetting -BodyParameter $setting
```

#### ãƒ¬ãƒ™ãƒ«2ï¼šæ•™å“¡é™å®šï¼ˆæ¨å¥¨ï¼šé«˜ç­‰å­¦æ ¡ï¼‰
- **å¯¾è±¡**ï¼šæ•™å“¡ã®ã¿
- **åˆ¶é™å†…å®¹**ï¼šç”Ÿå¾’ã¯ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆç¦æ­¢
- **ä½œæˆè€…**ï¼šæ•™å“¡ãƒ»ITç®¡ç†è€…

```powershell
# æ•™å“¡ç”¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ
$teacherGroupParams = @{
    DisplayName = "Microsoft365ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆæ¨©é™_æ•™å“¡"
    MailNickname = "group-creators-teachers"
    Description = "Microsoft 365ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã§ãã‚‹æ•™å“¡"
    GroupTypes = @()
    MailEnabled = $false
    SecurityEnabled = $true
}

$teacherGroup = New-MgGroup @teacherGroupParams

# ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆæ¨©é™ã‚’æ•™å“¡ã‚°ãƒ«ãƒ¼ãƒ—ã«é™å®š
$setting = @{
    TemplateId = $template.Id
    Values = @(
        @{
            Name = "EnableGroupCreation"
            Value = "false"
        },
        @{
            Name = "GroupCreationAllowedGroupId"
            Value = $teacherGroup.Id
        }
    )
}

New-MgDirectorySetting -BodyParameter $setting
```

#### ãƒ¬ãƒ™ãƒ«3ï¼šæ‰¿èªåˆ¶ï¼ˆæ¨å¥¨ï¼šå¤§å­¦ï¼‰
- **å¯¾è±¡**ï¼šå…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼
- **åˆ¶é™å†…å®¹**ï¼šä½œæˆæ™‚ã«æ‰¿èªãŒå¿…è¦
- **ä½œæˆè€…**ï¼šæ‰¿èªã•ã‚ŒãŸå…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼

```powershell
# æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®è¨­å®šï¼ˆMicrosoft Graph APIã‚’ä½¿ç”¨ï¼‰
$approvalPolicy = @{
    DisplayName = "Microsoft 365ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆæ‰¿èª"
    Description = "æ–°ã—ã„Microsoft 365ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆæ™‚ã®æ‰¿èªãƒ—ãƒ­ã‚»ã‚¹"
    RequestApprovalSettings = @{
        IsApprovalRequired = $true
        ApprovalStages = @(
            @{
                ApprovalStageTimeOutInDays = 7
                IsApproverJustificationRequired = $true
                PrimaryApprovers = @(
                    @{
                        "@odata.type" = "#microsoft.graph.singleUser"
                        UserId = "it-admin@school.edu.jp"
                    }
                )
            }
        )
    }
}
```

### æ®µéšçš„å±•é–‹æˆ¦ç•¥ï¼ˆGIGAã‚¹ã‚¯ãƒ¼ãƒ«æ§‹æƒ³å¯¾å¿œï¼‰

#### ğŸ¯ ç¬¬1ãƒ•ã‚§ãƒ¼ã‚ºï¼šåŸºç›¤æ§‹ç¯‰ï¼ˆ1-2ãƒ¶æœˆï¼‰

**ç›®æ¨™**ï¼šå®‰å…¨ãªç’°å¢ƒã®ç¢ºç«‹
```powershell
# Phase 1: å®Œå…¨åˆ¶é™ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
function Start-Phase1GroupRestriction {
    Write-Host "ğŸ”’ ç¬¬1ãƒ•ã‚§ãƒ¼ã‚ºï¼šå®Œå…¨ãªã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆåˆ¶é™ã‚’é–‹å§‹" -ForegroundColor Yellow
    
    # 1. ç¾åœ¨ã®è¨­å®šç¢ºèª
    $currentSetting = Get-MgDirectorySetting | Where-Object {$_.DisplayName -eq "Group.Unified"}
    if ($currentSetting) {
        Write-Host "æ—¢å­˜ã®è¨­å®šãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚æ›´æ–°ã—ã¾ã™ã€‚"
    }
    
    # 2. ITç®¡ç†è€…ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ
    $adminGroup = @{
        DisplayName = "M365ç®¡ç†è€…_ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆæ¨©é™"
        MailNickname = "m365-admin-group-creators"
        Description = "Microsoft 365ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆæ¨©é™ã‚’æŒã¤ç®¡ç†è€…"
        GroupTypes = @()
        MailEnabled = $false
        SecurityEnabled = $true
    }
    
    $adminGroupResult = New-MgGroup @adminGroup
    
    # 3. ITç®¡ç†è€…ã‚’ãƒ¡ãƒ³ãƒãƒ¼ã«è¿½åŠ 
    $adminUsers = @(
        "it-admin1@school.onmicrosoft.com",
        "it-admin2@school.onmicrosoft.com"
    )
    
    foreach ($admin in $adminUsers) {
        try {
            $user = Get-MgUser -Filter "userPrincipalName eq '$admin'"
            if ($user) {
                New-MgGroupMember -GroupId $adminGroupResult.Id -DirectoryObjectId $user.Id
                Write-Host "âœ… ç®¡ç†è€…ã‚’è¿½åŠ : $admin"
            }
        } catch {
            Write-Host "âš ï¸ ç®¡ç†è€…ã®è¿½åŠ ã«å¤±æ•—: $admin - $($_.Exception.Message)"
        }
    }
    
    # 4. ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆåˆ¶é™ã‚’é©ç”¨
    $template = Get-MgDirectorySettingTemplate | Where-Object {$_.DisplayName -eq "Group.Unified"}
    $restrictionSetting = @{
        TemplateId = $template.Id
        Values = @(
            @{Name = "EnableGroupCreation"; Value = "false"},
            @{Name = "GroupCreationAllowedGroupId"; Value = $adminGroupResult.Id},
            @{Name = "EnableMSStandardBlockedWords"; Value = "true"},
            @{Name = "PrefixSuffixNamingRequirement"; Value = "[å­¦æ ¡ã‚³ãƒ¼ãƒ‰]_[GroupName]_[å¹´åº¦]"},
            @{Name = "AllowGuestsToBeGroupOwner"; Value = "false"},
            @{Name = "AllowGuestsToAccessGroups"; Value = "false"},
            @{Name = "AllowToAddGuests"; Value = "false"},
            @{Name = "UsageGuidelinesUrl"; Value = "https://school.example.com/group-usage-guidelines"}
        )
    }
    
    if ($currentSetting) {
        Update-MgDirectorySetting -DirectorySettingId $currentSetting.Id -Values $restrictionSetting.Values
    } else {
        New-MgDirectorySetting @restrictionSetting
    }
    
    Write-Host "âœ… ç¬¬1ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†ï¼šã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆæ¨©é™ã‚’ç®¡ç†è€…ã®ã¿ã«åˆ¶é™ã—ã¾ã—ãŸ" -ForegroundColor Green
}
```

#### ğŸ“ ç¬¬2ãƒ•ã‚§ãƒ¼ã‚ºï¼šæ•™å“¡ã¸ã®æ®µéšçš„é–‹æ”¾ï¼ˆ2-4ãƒ¶æœˆï¼‰

**ç›®æ¨™**ï¼šæ•™è‚²ç¾å ´ã§ã®ã‚°ãƒ«ãƒ¼ãƒ—æ´»ç”¨é–‹å§‹
```powershell
# Phase 2: æ•™å“¡ã¸ã®æ¨©é™æ‹¡å¤§
function Start-Phase2TeacherAccess {
    Write-Host "ğŸ‘¨â€ğŸ« ç¬¬2ãƒ•ã‚§ãƒ¼ã‚ºï¼šæ•™å“¡ã¸ã®æ®µéšçš„æ¨©é™ä»˜ä¸ã‚’é–‹å§‹" -ForegroundColor Blue
    
    # 1. æ•™å“¡ç”¨ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆæ¨©é™ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ
    $teacherCreatorGroup = @{
        DisplayName = "æ•™å“¡_ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆæ¨©é™"
        MailNickname = "teachers-group-creators"
        Description = "Microsoft 365ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã§ãã‚‹æ•™å“¡"
        GroupTypes = @()
        MailEnabled = $false
        SecurityEnabled = $true
    }
    
    $teacherGroup = New-MgGroup @teacherCreatorGroup
    
    # 2. æ®µéšçš„ãªæ•™å“¡è¿½åŠ æˆ¦ç•¥
    $teacherCategories = @{
        "ç®¡ç†è·" = @("principal@school.onmicrosoft.com", "vice-principal@school.onmicrosoft.com")
        "å­¦å¹´ä¸»ä»»" = @("grade1-head@school.onmicrosoft.com", "grade2-head@school.onmicrosoft.com", "grade3-head@school.onmicrosoft.com")
        "æ•™ç§‘ä¸»ä»»" = @("math-head@school.onmicrosoft.com", "english-head@school.onmicrosoft.com", "science-head@school.onmicrosoft.com")
        "ICTæ¨é€²æ‹…å½“" = @("ict-leader1@school.onmicrosoft.com", "ict-leader2@school.onmicrosoft.com")
    }
    
    # 3. æ®µéšçš„ã«æ•™å“¡ã‚’è¿½åŠ ï¼ˆé€±æ¬¡ã§å®Ÿæ–½ï¼‰
    $week = 1
    foreach ($category in $teacherCategories.GetEnumerator()) {
        Write-Host "ç¬¬${week}é€±: $($category.Key)ã¸ã®æ¨©é™ä»˜ä¸" -ForegroundColor Cyan
        
        foreach ($teacher in $category.Value) {
            try {
                $user = Get-MgUser -Filter "userPrincipalName eq '$teacher'"
                if ($user) {
                    New-MgGroupMember -GroupId $teacherGroup.Id -DirectoryObjectId $user.Id
                    Write-Host "  âœ… è¿½åŠ : $teacher"
                    
                    # æ•™å“¡ã¸ã®é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡
                    Send-WelcomeNotification -UserEmail $teacher -Phase "Phase2"
                }
            } catch {
                Write-Host "  âš ï¸ è¿½åŠ å¤±æ•—: $teacher - $($_.Exception.Message)"
            }
        }
        $week++
        
        # é€±æ¬¡ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆ
        Write-Host "ğŸ“Š ç¬¬${week}é€±ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿæ–½æ¨å¥¨" -ForegroundColor Yellow
    }
    
    # 4. ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆæ¨©é™ã®æ›´æ–°
    $currentSetting = Get-MgDirectorySetting | Where-Object {$_.DisplayName -eq "Group.Unified"}
    $adminGroupId = ($currentSetting.Values | Where-Object {$_.Name -eq "GroupCreationAllowedGroupId"}).Value
    
    # æ—¢å­˜ã®ç®¡ç†è€…ã‚°ãƒ«ãƒ¼ãƒ—ã«æ•™å“¡ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ 
    $teacherMembers = Get-MgGroupMember -GroupId $teacherGroup.Id
    foreach ($member in $teacherMembers) {
        try {
            New-MgGroupMember -GroupId $adminGroupId -DirectoryObjectId $member.Id
        } catch {
            # æ—¢ã«è¿½åŠ æ¸ˆã¿ã®å ´åˆã¯ç„¡è¦–
        }
    }
    
    Write-Host "âœ… ç¬¬2ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†ï¼šæ•™å“¡ã«ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆæ¨©é™ã‚’ä»˜ä¸ã—ã¾ã—ãŸ" -ForegroundColor Green
}

# æ•™å“¡å‘ã‘é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡
function Send-WelcomeNotification {
    param(
        [string]$UserEmail,
        [string]$Phase
    )
    
    $subject = "Microsoft 365ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆæ¨©é™ã®ä»˜ä¸ã«ã¤ã„ã¦"
    $body = @"
$UserEmail æ§˜

Microsoft 365ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆæ¨©é™ãŒä»˜ä¸ã•ã‚Œã¾ã—ãŸã€‚

ã€åˆ©ç”¨å¯èƒ½ãªæ©Ÿèƒ½ã€‘
- ã‚¯ãƒ©ã‚¹ãƒ»æ•™ç§‘ãƒ»éƒ¨æ´»å‹•ç”¨ã®Teamsãƒãƒ¼ãƒ ä½œæˆ
- SharePointã‚µã‚¤ãƒˆã®è‡ªå‹•ä½œæˆ
- ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ¼ãƒ«ã®æ´»ç”¨

ã€é‡è¦ãªæ³¨æ„äº‹é …ã€‘
- ã‚°ãƒ«ãƒ¼ãƒ—åã¯å‘½åè¦å‰‡ã«å¾“ã£ã¦ãã ã•ã„
- ç”Ÿå¾’ã®å€‹äººæƒ…å ±ä¿è­·ã«é…æ…®ã—ã¦ãã ã•ã„
- ä¸è¦ãªã‚°ãƒ«ãƒ¼ãƒ—ã¯å®šæœŸçš„ã«å‰Šé™¤ã—ã¦ãã ã•ã„

ã€ã‚µãƒãƒ¼ãƒˆã€‘
ã”ä¸æ˜ãªç‚¹ã¯ ITç®¡ç†éƒ¨é–€ã¾ã§ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚

Microsoft 365ç®¡ç†ãƒãƒ¼ãƒ 
"@

    # å®Ÿéš›ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡å‡¦ç†ã¯ã“ã“ã«å®Ÿè£…
    Write-Host "ğŸ“§ é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡: $UserEmail"
}
```

#### ğŸš€ ç¬¬3ãƒ•ã‚§ãƒ¼ã‚ºï¼šå…¨é¢å±•é–‹ï¼ˆ4-6ãƒ¶æœˆï¼‰

**ç›®æ¨™**ï¼šçµ„ç¹”å…¨ä½“ã§ã®åŠ¹æœçš„ãªé‹ç”¨
```powershell
# Phase 3: å…¨é¢å±•é–‹ã¨é‹ç”¨æœ€é©åŒ–
function Start-Phase3FullDeployment {
    Write-Host "ğŸš€ ç¬¬3ãƒ•ã‚§ãƒ¼ã‚ºï¼šå…¨é¢å±•é–‹ã‚’é–‹å§‹" -ForegroundColor Green
    
    # 1. å…¨æ•™å“¡ã¸ã®æ¨©é™ä»˜ä¸
    $allTeachers = Get-MgUser -Filter "department eq 'æ•™å“¡'" -All
    $teacherGroupId = (Get-MgGroup -Filter "displayName eq 'æ•™å“¡_ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆæ¨©é™'").Id
    
    foreach ($teacher in $allTeachers) {
        try {
            New-MgGroupMember -GroupId $teacherGroupId -DirectoryObjectId $teacher.Id
        } catch {
            # æ—¢ã«è¿½åŠ æ¸ˆã¿ã®å ´åˆã¯ç„¡è¦–
        }
    }
    
    # 2. è‡ªå‹•åŒ–ã•ã‚ŒãŸã‚°ãƒ«ãƒ¼ãƒ—ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†ã®å®Ÿè£…
    Set-AutomatedGroupLifecycle
    
    # 3. ä½¿ç”¨çŠ¶æ³ã®ç›£è¦–é–‹å§‹
    Start-GroupUsageMonitoring
    
    # 4. ãƒ˜ãƒ«ãƒ—ãƒ‡ã‚¹ã‚¯ãƒ—ãƒ­ã‚»ã‚¹ã®ç¢ºç«‹
    Initialize-GroupSupportProcess
    
    Write-Host "âœ… ç¬¬3ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†ï¼šå…¨é¢å±•é–‹ãŒå®Œäº†ã—ã¾ã—ãŸ" -ForegroundColor Green
}

# è‡ªå‹•åŒ–ã•ã‚ŒãŸãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†
function Set-AutomatedGroupLifecycle {
    # ã‚°ãƒ«ãƒ¼ãƒ—ã®æœ‰åŠ¹æœŸé™è¨­å®š
    $lifecyclePolicy = @{
        GroupLifetimeInDays = 365
        ManagedGroupTypes = "All"
        AlternateNotificationEmails = "it-admin@school.onmicrosoft.com"
    }
    
    # å¹´åº¦æœ«è‡ªå‹•ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®è¨­å®š
    $yearEndScript = @'
# å¹´åº¦æœ«å®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ã‚¹ã‚¯ã¨ã—ã¦è¨­å®šï¼‰
$currentYear = (Get-Date).Year
$nextYear = $currentYear + 1

# å’æ¥­ã‚¯ãƒ©ã‚¹ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
$graduationGroups = Get-MgGroup -Filter "startsWith(displayName, 'CLASS_3')" -All
foreach ($group in $graduationGroups) {
    if ($group.DisplayName -like "*$currentYear*") {
        $archiveName = $group.DisplayName -replace $currentYear, "$currentYear-GRADUATED"
        Update-MgGroup -GroupId $group.Id -DisplayName $archiveName
    }
}

# é€²ç´šã«ã‚ˆã‚‹ã‚°ãƒ«ãƒ¼ãƒ—æ›´æ–°
Update-AcademicYearGroups -OldYear $currentYear -NewYear $nextYear
'@

    # ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
    $yearEndScript | Out-File -FilePath "C:\Scripts\YearEndGroupMaintenance.ps1" -Encoding UTF8
    
    Write-Host "ğŸ“… å¹´åº¦æœ«è‡ªå‹•å‡¦ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¨­å®šã•ã‚Œã¾ã—ãŸ"
}
```

### å¹´æ¬¡æ›´æ–°ãƒ—ãƒ­ã‚»ã‚¹

```powershell
# å¹´åº¦æ›´æ–°æ™‚ã®ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
function Update-AcademicYearGroups {
    param(
        [int]$OldYear = 2024,
        [int]$NewYear = 2025
    )
    
    # å‰å¹´åº¦ã‚°ãƒ«ãƒ¼ãƒ—ã®æ¤œç´¢
    $oldGroups = Get-MgGroup -Filter "startswith(displayName, 'CLASS_') or startswith(displayName, 'SUBJECT_')" -All
    
    foreach ($group in $oldGroups) {
        if ($group.DisplayName -like "*$OldYear*") {
            # ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‡¦ç†
            $archiveName = $group.DisplayName -replace $OldYear, "$OldYear-ARCHIVED"
            Update-MgGroup -GroupId $group.Id -DisplayName $archiveName
            
            # æ–°å¹´åº¦ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ
            $newName = $group.DisplayName -replace $OldYear, $NewYear
            $newGroup = @{
                DisplayName = $newName
                MailNickname = ($group.MailNickname -replace $OldYear, $NewYear)
                Description = $group.Description -replace $OldYear, $NewYear
                GroupTypes = @("Unified")
                MailEnabled = $true
                SecurityEnabled = $false
                Visibility = $group.Visibility
            }
            
            New-MgGroup @newGroup
            Write-Host "æ–°å¹´åº¦ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆ: $newName"
        }
    }
}
```

### ğŸ”„ è‡ªå‹•åŒ–ã•ã‚ŒãŸå¹´åº¦æœ«å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ 

æ•™è‚²æ©Ÿé–¢ã§ã¯å¹´åº¦æœ«ï¼ˆ3æœˆï¼‰ã«å¤§è¦æ¨¡ãªã‚°ãƒ«ãƒ¼ãƒ—å†ç·¨ãŒå¿…è¦ã§ã™ã€‚ã“ã®ä½œæ¥­ã‚’è‡ªå‹•åŒ–ã™ã‚‹ã“ã¨ã§ã€ç®¡ç†è² è·ã‚’å¤§å¹…ã«å‰Šæ¸›ã§ãã¾ã™ã€‚

#### ğŸ“… å¹´åº¦æœ«å‡¦ç†ã®å…¨ä½“ãƒ•ãƒ­ãƒ¼

```mermaid
graph TD
    A[2æœˆä¸­æ—¬: æº–å‚™ãƒ•ã‚§ãƒ¼ã‚º] --> B[3æœˆä¸Šæ—¬: ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—]
    B --> C[3æœˆä¸­æ—¬: å’æ¥­å‡¦ç†]
    C --> D[3æœˆä¸‹æ—¬: é€²ç´šå‡¦ç†]
    D --> E[4æœˆä¸Šæ—¬: æ–°å…¥ç”Ÿå¯¾å¿œ]
    E --> F[4æœˆä¸­æ—¬: æ¤œè¨¼ãƒ»èª¿æ•´]
    
    A --> A1[ç¾åœ¨ã®ã‚°ãƒ«ãƒ¼ãƒ—æ£šå¸ã—]
    A --> A2[ä¸è¦ã‚°ãƒ«ãƒ¼ãƒ—ã®ç‰¹å®š]
    A --> A3[å¹´åº¦æœ«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç­–å®š]
    
    C --> C1[3å¹´ç”Ÿã‚°ãƒ«ãƒ¼ãƒ—ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–]
    C --> C2[å’æ¥­ç”Ÿã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ç„¡åŠ¹åŒ–]
    C --> C3[ä¿è­·è€…ã‚°ãƒ«ãƒ¼ãƒ—ã®æ›´æ–°]
    
    D --> D1[1â†’2å¹´ã€2â†’3å¹´ã®é€²ç´šå‡¦ç†]
    D --> D2[æ–°1å¹´ç”Ÿã‚°ãƒ«ãƒ¼ãƒ—ã®æº–å‚™]
    D --> D3[æ•™å“¡é…ç½®å¤‰æ›´ã®åæ˜ ]
```

#### ğŸ¤– å®Œå…¨è‡ªå‹•åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```powershell
# å¹´åº¦æœ«å®Œå…¨è‡ªå‹•å‡¦ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
function Invoke-CompleteYearEndProcessing {
    param(
        [int]$CurrentYear = (Get-Date).Year,
        [switch]$DryRun = $false
    )
    
    $nextYear = $CurrentYear + 1
    $logPath = "C:\Logs\YearEndProcessing_$($CurrentYear)_$(Get-Date -Format 'yyyyMMddHHmm').log"
    
    Start-Transcript -Path $logPath
    
    try {
        Write-Host "ğŸš€ å¹´åº¦æœ«å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™ï¼ˆ$CurrentYear â†’ $nextYearï¼‰" -ForegroundColor Green
        
        # ãƒ•ã‚§ãƒ¼ã‚º1: äº‹å‰ç¢ºèªã¨æº–å‚™
        Write-Host "`nğŸ“‹ ãƒ•ã‚§ãƒ¼ã‚º1: äº‹å‰ç¢ºèª" -ForegroundColor Yellow
        $currentGroups = Get-AllEducationGroups -Year $CurrentYear
        Write-Host "å¯¾è±¡ã‚°ãƒ«ãƒ¼ãƒ—æ•°: $($currentGroups.Count)"
        
        # ãƒ•ã‚§ãƒ¼ã‚º2: ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
        Write-Host "`nğŸ’¾ ãƒ•ã‚§ãƒ¼ã‚º2: ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—" -ForegroundColor Yellow
        if (-not $DryRun) {
            Backup-GroupData -Groups $currentGroups -BackupPath "C:\Backup\Groups_$CurrentYear"
        }
        
        # ãƒ•ã‚§ãƒ¼ã‚º3: å’æ¥­å‡¦ç†
        Write-Host "`nğŸ“ ãƒ•ã‚§ãƒ¼ã‚º3: å’æ¥­å‡¦ç†" -ForegroundColor Yellow
        $graduationGroups = $currentGroups | Where-Object {$_.DisplayName -like "*3å¹´*" -or $_.DisplayName -like "*GRADE3*"}
        Process-GraduationGroups -Groups $graduationGroups -DryRun:$DryRun
        
        # ãƒ•ã‚§ãƒ¼ã‚º4: é€²ç´šå‡¦ç†
        Write-Host "`nâ¬†ï¸ ãƒ•ã‚§ãƒ¼ã‚º4: é€²ç´šå‡¦ç†" -ForegroundColor Yellow
        Process-GradePromotion -CurrentYear $CurrentYear -NextYear $nextYear -DryRun:$DryRun
        
        # ãƒ•ã‚§ãƒ¼ã‚º5: æ–°å…¥ç”Ÿæº–å‚™
        Write-Host "`nğŸ†• ãƒ•ã‚§ãƒ¼ã‚º5: æ–°å…¥ç”Ÿã‚°ãƒ«ãƒ¼ãƒ—æº–å‚™" -ForegroundColor Yellow
        Prepare-NewStudentGroups -Year $nextYear -DryRun:$DryRun
        
        # ãƒ•ã‚§ãƒ¼ã‚º6: æ•™å“¡é…ç½®æ›´æ–°
        Write-Host "`nğŸ‘¨â€ğŸ« ãƒ•ã‚§ãƒ¼ã‚º6: æ•™å“¡é…ç½®æ›´æ–°" -ForegroundColor Yellow
        Update-TeacherAssignments -Year $nextYear -DryRun:$DryRun
        
        # ãƒ•ã‚§ãƒ¼ã‚º7: æ¤œè¨¼ã¨å ±å‘Š
        Write-Host "`nâœ… ãƒ•ã‚§ãƒ¼ã‚º7: æ¤œè¨¼ã¨å ±å‘Š" -ForegroundColor Yellow
        $report = Generate-YearEndReport -OldYear $CurrentYear -NewYear $nextYear
        
        Write-Host "`nğŸ‰ å¹´åº¦æœ«å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼" -ForegroundColor Green
        
    } catch {
        Write-Error "å¹´åº¦æœ«å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: $($_.Exception.Message)"
        Send-AlertNotification -Subject "å¹´åº¦æœ«å‡¦ç†ã‚¨ãƒ©ãƒ¼" -Message $_.Exception.Message
    } finally {
        Stop-Transcript
        Send-CompletionReport -LogPath $logPath -Report $report
    }
}

# æ•™è‚²ã‚°ãƒ«ãƒ¼ãƒ—ã®å–å¾—
function Get-AllEducationGroups {
    param([int]$Year)
    
    $educationPrefixes = @("CLASS_", "SUBJECT_", "CLUB_", "COMMITTEE_", "STAFF_", "PROJECT_", "PARENT_")
    $allGroups = @()
    
    foreach ($prefix in $educationPrefixes) {
        $groups = Get-MgGroup -Filter "startswith(displayName, '$prefix')" -All
        $yearGroups = $groups | Where-Object {$_.DisplayName -like "*$Year*"}
        $allGroups += $yearGroups
    }
    
    return $allGroups
}

# å’æ¥­ã‚°ãƒ«ãƒ¼ãƒ—å‡¦ç†
function Process-GraduationGroups {
    param(
        [array]$Groups,
        [switch]$DryRun
    )
    
    foreach ($group in $Groups) {
        Write-Host "ğŸ“ å’æ¥­å‡¦ç†: $($group.DisplayName)"
        
        if (-not $DryRun) {
            # ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ¢ãƒ¼ãƒ‰ã«è¨­å®š
            $archiveName = $group.DisplayName + "_GRADUATED"
            Update-MgGroup -GroupId $group.Id -DisplayName $archiveName -Description "å’æ¥­ã«ã‚ˆã‚Šçµ‚äº† - $(Get-Date -Format 'yyyyå¹´MMæœˆddæ—¥')"
            
            # Teamsãƒãƒ¼ãƒ ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
            try {
                $team = Get-MgTeam -TeamId $group.Id -ErrorAction SilentlyContinue
                if ($team) {
                    # Teams ã‚¢ãƒ¼ã‚«ã‚¤ãƒ– APIï¼ˆå®Ÿè£…ä¾‹ï¼‰
                    Invoke-MgArchiveTeam -TeamId $group.Id
                    Write-Host "  âœ… Teamsãƒãƒ¼ãƒ ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¾ã—ãŸ"
                }
            } catch {
                Write-Host "  âš ï¸ Teamsã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã«å¤±æ•—: $($_.Exception.Message)"
            }
            
            # SharePointã‚µã‚¤ãƒˆã®èª­ã¿å–ã‚Šå°‚ç”¨è¨­å®š
            Set-SharePointSiteReadOnly -GroupId $group.Id
        }
    }
}

# é€²ç´šå‡¦ç†
function Process-GradePromotion {
    param(
        [int]$CurrentYear,
        [int]$NextYear,
        [switch]$DryRun
    )
    
    $promotionMap = @{
        "1å¹´" = "2å¹´"
        "2å¹´" = "3å¹´"
        "GRADE1" = "GRADE2"
        "GRADE2" = "GRADE3"
    }
    
    foreach ($oldGrade in $promotionMap.Keys) {
        $newGrade = $promotionMap[$oldGrade]
        
        $gradeGroups = Get-MgGroup -Filter "contains(displayName, '$oldGrade') and contains(displayName, '$CurrentYear')" -All
        
        foreach ($group in $gradeGroups) {
            Write-Host "â¬†ï¸ é€²ç´šå‡¦ç†: $($group.DisplayName)"
            
            if (-not $DryRun) {
                # æ–°ã—ã„ã‚°ãƒ«ãƒ¼ãƒ—åã®ç”Ÿæˆ
                $newName = $group.DisplayName -replace $oldGrade, $newGrade
                $newName = $newName -replace $CurrentYear, $NextYear
                
                # æ–°å¹´åº¦ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ
                $newGroupParams = @{
                    DisplayName = $newName
                    MailNickname = $group.MailNickname -replace $CurrentYear, $NextYear
                    Description = $group.Description -replace $CurrentYear, $NextYear
                    GroupTypes = $group.GroupTypes
                    MailEnabled = $group.MailEnabled
                    SecurityEnabled = $group.SecurityEnabled
                    Visibility = $group.Visibility
                }
                
                $newGroup = New-MgGroup @newGroupParams
                
                # ã‚ªãƒ¼ãƒŠãƒ¼ã®å¼•ãç¶™ã
                $owners = Get-MgGroupOwner -GroupId $group.Id
                foreach ($owner in $owners) {
                    New-MgGroupOwner -GroupId $newGroup.Id -DirectoryObjectId $owner.Id
                }
                
                # Teamsãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®é©ç”¨
                if ($group.GroupTypes -contains "Unified") {
                    New-MgTeam -GroupId $newGroup.Id -BodyParameter @{
                        "template@odata.bind" = "https://graph.microsoft.com/v1.0/teamsTemplates('educationClass')"
                    }
                }
                
                Write-Host "  âœ… æ–°å¹´åº¦ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆ: $newName"
            }
        }
    }
}

# æ–°å…¥ç”Ÿã‚°ãƒ«ãƒ¼ãƒ—æº–å‚™
function Prepare-NewStudentGroups {
    param(
        [int]$Year,
        [switch]$DryRun
    )
    
    $newStudentGroups = @(
        @{Name = "CLASS_1A_HOMEROOM_$Year"; Description = "1å¹´Açµ„ãƒ›ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ "},
        @{Name = "CLASS_1B_HOMEROOM_$Year"; Description = "1å¹´Bçµ„ãƒ›ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ "},
        @{Name = "CLASS_1C_HOMEROOM_$Year"; Description = "1å¹´Cçµ„ãƒ›ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ "},
        @{Name = "SUBJECT_MATH_GRADE1_$Year"; Description = "1å¹´ç”Ÿæ•°å­¦"},
        @{Name = "SUBJECT_ENGLISH_GRADE1_$Year"; Description = "1å¹´ç”Ÿè‹±èª"}
    )
    
    foreach ($groupTemplate in $newStudentGroups) {
        Write-Host "ğŸ†• æ–°å…¥ç”Ÿã‚°ãƒ«ãƒ¼ãƒ—æº–å‚™: $($groupTemplate.Name)"
        
        if (-not $DryRun) {
            $groupParams = @{
                DisplayName = $groupTemplate.Name
                MailNickname = $groupTemplate.Name.ToLower() -replace "_", "-"
                Description = $groupTemplate.Description
                GroupTypes = @("Unified")
                MailEnabled = $true
                SecurityEnabled = $false
                Visibility = "Private"
            }
            
            $newGroup = New-MgGroup @groupParams
            
            # åŸºæœ¬ãƒãƒ£ãƒ³ãƒãƒ«ã®è¨­å®š
            New-MgTeam -GroupId $newGroup.Id -BodyParameter @{
                "template@odata.bind" = "https://graph.microsoft.com/v1.0/teamsTemplates('educationClass')"
            }
            
            Write-Host "  âœ… ä½œæˆå®Œäº†: $($groupTemplate.Name)"
        }
    }
}

# æ•™å“¡é…ç½®æ›´æ–°
function Update-TeacherAssignments {
    param(
        [int]$Year,
        [switch]$DryRun
    )
    
    # CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æ–°å¹´åº¦ã®æ•™å“¡é…ç½®ã‚’èª­ã¿è¾¼ã¿
    $assignmentFile = "C:\Config\TeacherAssignments_$Year.csv"
    
    if (Test-Path $assignmentFile) {
        $assignments = Import-Csv $assignmentFile
        
        foreach ($assignment in $assignments) {
            Write-Host "ğŸ‘¨â€ğŸ« æ•™å“¡é…ç½®æ›´æ–°: $($assignment.Teacher) â†’ $($assignment.Group)"
            
            if (-not $DryRun) {
                $teacher = Get-MgUser -Filter "userPrincipalName eq '$($assignment.Teacher)'"
                $group = Get-MgGroup -Filter "displayName eq '$($assignment.Group)'"
                
                if ($teacher -and $group) {
                    # å½¹å‰²ã«å¿œã˜ãŸæ¨©é™è¨­å®š
                    if ($assignment.Role -eq "Owner") {
                        New-MgGroupOwner -GroupId $group.Id -DirectoryObjectId $teacher.Id
                    } else {
                        New-MgGroupMember -GroupId $group.Id -DirectoryObjectId $teacher.Id
                    }
                    
                    Write-Host "  âœ… é…ç½®å®Œäº†"
                } else {
                    Write-Host "  âš ï¸ æ•™å“¡ã¾ãŸã¯ã‚°ãƒ«ãƒ¼ãƒ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
                }
            }
        }
    } else {
        Write-Host "âš ï¸ æ•™å“¡é…ç½®ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $assignmentFile"
    }
}

# å¹´åº¦æœ«ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
function Generate-YearEndReport {
    param(
        [int]$OldYear,
        [int]$NewYear
    )
    
    $report = @{
        ProcessDate = Get-Date
        OldYear = $OldYear
        NewYear = $NewYear
        ArchivedGroups = @()
        CreatedGroups = @()
        Errors = @()
        Summary = @{}
    }
    
    # ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã•ã‚ŒãŸã‚°ãƒ«ãƒ¼ãƒ—ã®é›†è¨ˆ
    $archivedGroups = Get-MgGroup -Filter "contains(displayName, 'ARCHIVED') or contains(displayName, 'GRADUATED')" -All
    $report.ArchivedGroups = $archivedGroups.Count
    
    # æ–°è¦ä½œæˆã•ã‚ŒãŸã‚°ãƒ«ãƒ¼ãƒ—ã®é›†è¨ˆ
    $newGroups = Get-MgGroup -Filter "contains(displayName, '$NewYear')" -All
    $report.CreatedGroups = $newGroups.Count
    
    # ã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ
    $report.Summary = @{
        TotalProcessed = $archivedGroups.Count + $newGroups.Count
        Success = $true
        Duration = "å‡¦ç†æ™‚é–“ã‚’è¨ˆç®—"
    }
    
    # ãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›
    $reportPath = "C:\Reports\YearEndReport_$($OldYear)to$($NewYear)_$(Get-Date -Format 'yyyyMMdd').json"
    $report | ConvertTo-Json -Depth 3 | Out-File -FilePath $reportPath -Encoding UTF8
    
    return $report
}

# è‡ªå‹•å®Ÿè¡Œè¨­å®šï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ã‚¹ã‚¯ï¼‰
function Register-YearEndScheduledTask {
    param(
        [datetime]$ExecutionDate = [datetime]"2025/03/15 02:00:00"
    )
    
    $action = New-ScheduledTaskAction -Execute "PowerShell.exe" -Argument "-File C:\Scripts\YearEndProcessing.ps1"
    $trigger = New-ScheduledTaskTrigger -Once -At $ExecutionDate
    $settings = New-ScheduledTaskSettingsSet -ExecutionTimeLimit (New-TimeSpan -Hours 4)
    
    Register-ScheduledTask -TaskName "Microsoft365YearEndProcessing" -Action $action -Trigger $trigger -Settings $settings -User "SYSTEM"
    
    Write-Host "âœ… å¹´åº¦æœ«å‡¦ç†ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ã‚¹ã‚¯ãŒç™»éŒ²ã•ã‚Œã¾ã—ãŸ: $ExecutionDate"
}
```

#### ğŸ¯ ç¬¬1ãƒ•ã‚§ãƒ¼ã‚ºï¼šåŸºç›¤æ§‹ç¯‰ï¼ˆ1-2ãƒ¶æœˆï¼‰

**ç›®æ¨™**ï¼šå®‰å…¨ãªç’°å¢ƒã®ç¢ºç«‹
```powershell
# Phase 1: å®Œå…¨åˆ¶é™ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
function Start-Phase1GroupRestriction {
    Write-Host "ğŸ”’ ç¬¬1ãƒ•ã‚§ãƒ¼ã‚ºï¼šå®Œå…¨ãªã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆåˆ¶é™ã‚’é–‹å§‹" -ForegroundColor Yellow
    
    # 1. ç¾åœ¨ã®è¨­å®šç¢ºèª
    $currentSetting = Get-MgDirectorySetting | Where-Object {$_.DisplayName -eq "Group.Unified"}
    if ($currentSetting) {
        Write-Host "æ—¢å­˜ã®è¨­å®šãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚æ›´æ–°ã—ã¾ã™ã€‚"
    }
    
    # 2. ITç®¡ç†è€…ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ
    $adminGroup = @{
        DisplayName = "M365ç®¡ç†è€…_ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆæ¨©é™"
        MailNickname = "m365-admin-group-creators"
        Description = "Microsoft 365ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆæ¨©é™ã‚’æŒã¤ç®¡ç†è€…"
        GroupTypes = @()
        MailEnabled = $false
        SecurityEnabled = $true
    }
    
    $adminGroupResult = New-MgGroup @adminGroup
    
    # 3. ITç®¡ç†è€…ã‚’ãƒ¡ãƒ³ãƒãƒ¼ã«è¿½åŠ 
    $adminUsers = @(
        "it-admin1@school.onmicrosoft.com",
        "it-admin2@school.onmicrosoft.com"
    )
    
    foreach ($admin in $adminUsers) {
        try {
            $user = Get-MgUser -Filter "userPrincipalName eq '$admin'"
            if ($user) {
                New-MgGroupMember -GroupId $adminGroupResult.Id -DirectoryObjectId $user.Id
                Write-Host "âœ… ç®¡ç†è€…ã‚’è¿½åŠ : $admin"
            }
        } catch {
            Write-Host "âš ï¸ ç®¡ç†è€…ã®è¿½åŠ ã«å¤±æ•—: $admin - $($_.Exception.Message)"
        }
    }
    
    # 4. ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆåˆ¶é™ã‚’é©ç”¨
    $template = Get-MgDirectorySettingTemplate | Where-Object {$_.DisplayName -eq "Group.Unified"}
    $restrictionSetting = @{
        TemplateId = $template.Id
        Values = @(
            @{Name = "EnableGroupCreation"; Value = "false"},
            @{Name = "GroupCreationAllowedGroupId"; Value = $adminGroupResult.Id},
            @{Name = "EnableMSStandardBlockedWords"; Value = "true"},
            @{Name = "PrefixSuffixNamingRequirement"; Value = "[å­¦æ ¡ã‚³ãƒ¼ãƒ‰]_[GroupName]_[å¹´åº¦]"},
            @{Name = "AllowGuestsToBeGroupOwner"; Value = "false"},
            @{Name = "AllowGuestsToAccessGroups"; Value = "false"},
            @{Name = "AllowToAddGuests"; Value = "false"},
            @{Name = "UsageGuidelinesUrl"; Value = "https://school.example.com/group-usage-guidelines"}
        )
    }
    
    if ($currentSetting) {
        Update-MgDirectorySetting -DirectorySettingId $currentSetting.Id -Values $restrictionSetting.Values
    } else {
        New-MgDirectorySetting @restrictionSetting
    }
    
    Write-Host "âœ… ç¬¬1ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†ï¼šã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆæ¨©é™ã‚’ç®¡ç†è€…ã®ã¿ã«åˆ¶é™ã—ã¾ã—ãŸ" -ForegroundColor Green
}
```

#### ğŸ“ ç¬¬2ãƒ•ã‚§ãƒ¼ã‚ºï¼šæ•™å“¡ã¸ã®æ®µéšçš„é–‹æ”¾ï¼ˆ2-4ãƒ¶æœˆï¼‰

**ç›®æ¨™**ï¼šæ•™è‚²ç¾å ´ã§ã®ã‚°ãƒ«ãƒ¼ãƒ—æ´»ç”¨é–‹å§‹
```powershell
# Phase 2: æ•™å“¡ã¸ã®æ¨©é™æ‹¡å¤§
function Start-Phase2TeacherAccess {
    Write-Host "ğŸ‘¨â€ğŸ« ç¬¬2ãƒ•ã‚§ãƒ¼ã‚ºï¼šæ•™å“¡ã¸ã®æ®µéšçš„æ¨©é™ä»˜ä¸ã‚’é–‹å§‹" -ForegroundColor Blue
    
    # 1. æ•™å“¡ç”¨ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆæ¨©é™ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ
    $teacherCreatorGroup = @{
        DisplayName = "æ•™å“¡_ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆæ¨©é™"
        MailNickname = "teachers-group-creators"
        Description = "Microsoft 365ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã§ãã‚‹æ•™å“¡"
        GroupTypes = @()
        MailEnabled = $false
        SecurityEnabled = $true
    }
    
    $teacherGroup = New-MgGroup @teacherCreatorGroup
    
    # 2. æ®µéšçš„ãªæ•™å“¡è¿½åŠ æˆ¦ç•¥
    $teacherCategories = @{
        "ç®¡ç†è·" = @("principal@school.onmicrosoft.com", "vice-principal@school.onmicrosoft.com")
        "å­¦å¹´ä¸»ä»»" = @("grade1-head@school.onmicrosoft.com", "grade2-head@school.onmicrosoft.com", "grade3-head@school.onmicrosoft.com")
        "æ•™ç§‘ä¸»ä»»" = @("math-head@school.onmicrosoft.com", "english-head@school.onmicrosoft.com", "science-head@school.onmicrosoft.com")
        "ICTæ¨é€²æ‹…å½“" = @("ict-leader1@school.onmicrosoft.com", "ict-leader2@school.onmicrosoft.com")
    }
    
    # 3. æ®µéšçš„ã«æ•™å“¡ã‚’è¿½åŠ ï¼ˆé€±æ¬¡ã§å®Ÿæ–½ï¼‰
    $week = 1
    foreach ($category in $teacherCategories.GetEnumerator()) {
        Write-Host "ç¬¬${week}é€±: $($category.Key)ã¸ã®æ¨©é™ä»˜ä¸" -ForegroundColor Cyan
        
        foreach ($teacher in $category.Value) {
            try {
                $user = Get-MgUser -Filter "userPrincipalName eq '$teacher'"
                if ($user) {
                    New-MgGroupMember -GroupId $teacherGroup.Id -DirectoryObjectId $user.Id
                    Write-Host "  âœ… è¿½åŠ : $teacher"
                    
                    # æ•™å“¡ã¸ã®é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡
                    Send-WelcomeNotification -UserEmail $teacher -Phase "Phase2"
                }
            } catch {
                Write-Host "  âš ï¸ è¿½åŠ å¤±æ•—: $teacher - $($_.Exception.Message)"
            }
        }
        $week++
        
        # é€±æ¬¡ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆ
        Write-Host "ğŸ“Š ç¬¬${week}é€±ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿæ–½æ¨å¥¨" -ForegroundColor Yellow
    }
    
    # 4. ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆæ¨©é™ã®æ›´æ–°
    $currentSetting = Get-MgDirectorySetting | Where-Object {$_.DisplayName -eq "Group.Unified"}
    $adminGroupId = ($currentSetting.Values | Where-Object {$_.Name -eq "GroupCreationAllowedGroupId"}).Value
    
    # æ—¢å­˜ã®ç®¡ç†è€…ã‚°ãƒ«ãƒ¼ãƒ—ã«æ•™å“¡ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ 
    $teacherMembers = Get-MgGroupMember -GroupId $teacherGroup.Id
    foreach ($member in $teacherMembers) {
        try {
            New-MgGroupMember -GroupId $adminGroupId -DirectoryObjectId $member.Id
        } catch {
            # æ—¢ã«è¿½åŠ æ¸ˆã¿ã®å ´åˆã¯ç„¡è¦–
        }
    }
    
    Write-Host "âœ… ç¬¬2ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†ï¼šæ•™å“¡ã«ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆæ¨©é™ã‚’ä»˜ä¸ã—ã¾ã—ãŸ" -ForegroundColor Green
}

# æ•™å“¡å‘ã‘é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡
function Send-WelcomeNotification {
    param(
        [string]$UserEmail,
        [string]$Phase
    )
    
    $subject = "Microsoft 365ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆæ¨©é™ã®ä»˜ä¸ã«ã¤ã„ã¦"
    $body = @"
$UserEmail æ§˜

Microsoft 365ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆæ¨©é™ãŒä»˜ä¸ã•ã‚Œã¾ã—ãŸã€‚

ã€åˆ©ç”¨å¯èƒ½ãªæ©Ÿèƒ½ã€‘
- ã‚¯ãƒ©ã‚¹ãƒ»æ•™ç§‘ãƒ»éƒ¨æ´»å‹•ç”¨ã®Teamsãƒãƒ¼ãƒ ä½œæˆ
- SharePointã‚µã‚¤ãƒˆã®è‡ªå‹•ä½œæˆ
- ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ¼ãƒ«ã®æ´»ç”¨

ã€é‡è¦ãªæ³¨æ„äº‹é …ã€‘
- ã‚°ãƒ«ãƒ¼ãƒ—åã¯å‘½åè¦å‰‡ã«å¾“ã£ã¦ãã ã•ã„
- ç”Ÿå¾’ã®å€‹äººæƒ…å ±ä¿è­·ã«é…æ…®ã—ã¦ãã ã•ã„
- ä¸è¦ãªã‚°ãƒ«ãƒ¼ãƒ—ã¯å®šæœŸçš„ã«å‰Šé™¤ã—ã¦ãã ã•ã„

ã€ã‚µãƒãƒ¼ãƒˆã€‘
ã”ä¸æ˜ãªç‚¹ã¯ ITç®¡ç†éƒ¨é–€ã¾ã§ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚

Microsoft 365ç®¡ç†ãƒãƒ¼ãƒ 
"@

    # å®Ÿéš›ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡å‡¦ç†ã¯ã“ã“ã«å®Ÿè£…
    Write-Host "ğŸ“§ é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡: $UserEmail"
}
```

#### ğŸš€ ç¬¬3ãƒ•ã‚§ãƒ¼ã‚ºï¼šå…¨é¢å±•é–‹ï¼ˆ4-6ãƒ¶æœˆï¼‰

**ç›®æ¨™**ï¼šçµ„ç¹”å…¨ä½“ã§ã®åŠ¹æœçš„ãªé‹ç”¨
```powershell
# Phase 3: å…¨é¢å±•é–‹ã¨é‹ç”¨æœ€é©åŒ–
function Start-Phase3FullDeployment {
    Write-Host "ğŸš€ ç¬¬3ãƒ•ã‚§ãƒ¼ã‚ºï¼šå…¨é¢å±•é–‹ã‚’é–‹å§‹" -ForegroundColor Green
    
    # 1. å…¨æ•™å“¡ã¸ã®æ¨©é™ä»˜ä¸
    $allTeachers = Get-MgUser -Filter "department eq 'æ•™å“¡'" -All
    $teacherGroupId = (Get-MgGroup -Filter "displayName eq 'æ•™å“¡_ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆæ¨©é™'").Id
    
    foreach ($teacher in $allTeachers) {
        try {
            New-MgGroupMember -GroupId $teacherGroupId -DirectoryObjectId $teacher.Id
        } catch {
            # æ—¢ã«è¿½åŠ æ¸ˆã¿ã®å ´åˆã¯ç„¡è¦–
        }
    }
    
    # 2. è‡ªå‹•åŒ–ã•ã‚ŒãŸã‚°ãƒ«ãƒ¼ãƒ—ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†ã®å®Ÿè£…
    Set-AutomatedGroupLifecycle
    
    # 3. ä½¿ç”¨çŠ¶æ³ã®ç›£è¦–é–‹å§‹
    Start-GroupUsageMonitoring
    
    # 4. ãƒ˜ãƒ«ãƒ—ãƒ‡ã‚¹ã‚¯ãƒ—ãƒ­ã‚»ã‚¹ã®ç¢ºç«‹
    Initialize-GroupSupportProcess
    
    Write-Host "âœ… ç¬¬3ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†ï¼šå…¨é¢å±•é–‹ãŒå®Œäº†ã—ã¾ã—ãŸ" -ForegroundColor Green
}

# è‡ªå‹•åŒ–ã•ã‚ŒãŸãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†
function Set-AutomatedGroupLifecycle {
    # ã‚°ãƒ«ãƒ¼ãƒ—ã®æœ‰åŠ¹æœŸé™è¨­å®š
    $lifecyclePolicy = @{
        GroupLifetimeInDays = 365
        ManagedGroupTypes = "All"
        AlternateNotificationEmails = "it-admin@school.onmicrosoft.com"
    }
    
    # å¹´åº¦æœ«è‡ªå‹•ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®è¨­å®š
    $yearEndScript = @'
# å¹´åº¦æœ«å®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ã‚¹ã‚¯ã¨ã—ã¦è¨­å®šï¼‰
$currentYear = (Get-Date).Year
$nextYear = $currentYear + 1

# å’æ¥­ã‚¯ãƒ©ã‚¹ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
$graduationGroups = Get-MgGroup -Filter "startsWith(displayName, 'CLASS_3')" -All
foreach ($group in $graduationGroups) {
    if ($group.DisplayName -like "*$currentYear*") {
        $archiveName = $group.DisplayName -replace $currentYear, "$currentYear-GRADUATED"
        Update-MgGroup -GroupId $group.Id -DisplayName $archiveName
    }
}

# é€²ç´šã«ã‚ˆã‚‹ã‚°ãƒ«ãƒ¼ãƒ—æ›´æ–°
Update-AcademicYearGroups -OldYear $currentYear -NewYear $nextYear
'@

    # ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
    $yearEndScript | Out-File -FilePath "C:\Scripts\YearEndGroupMaintenance.ps1" -Encoding UTF8
    
    Write-Host "ğŸ“… å¹´åº¦æœ«è‡ªå‹•å‡¦ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¨­å®šã•ã‚Œã¾ã—ãŸ"
}
```

### å¹´æ¬¡æ›´æ–°ãƒ—ãƒ­ã‚»ã‚¹

```powershell
# å¹´åº¦æ›´æ–°æ™‚ã®ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
function Update-AcademicYearGroups {
    param(
        [int]$OldYear = 2024,
        [int]$NewYear = 2025
    )
    
    # å‰å¹´åº¦ã‚°ãƒ«ãƒ¼ãƒ—ã®æ¤œç´¢
    $oldGroups = Get-MgGroup -Filter "startswith(displayName, 'CLASS_') or startswith(displayName, 'SUBJECT_')" -All
    
    foreach ($group in $oldGroups) {
        if ($group.DisplayName -like "*$OldYear*") {
            # ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‡¦ç†
            $archiveName = $group.DisplayName -replace $OldYear, "$OldYear-ARCHIVED"
            Update-MgGroup -GroupId $group.Id -DisplayName $archiveName
            
            # æ–°å¹´åº¦ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ
            $newName = $group.DisplayName -replace $OldYear, $NewYear
            $newGroup = @{
                DisplayName = $newName
                MailNickname = ($group.MailNickname -replace $OldYear, $NewYear)
                Description = $group.Description -replace $OldYear, $NewYear
                GroupTypes = @("Unified")
                MailEnabled = $true
                SecurityEnabled = $false
                Visibility = $group.Visibility
            }
            
            New-MgGroup @newGroup
            Write-Host "æ–°å¹´åº¦ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆ: $newName"
        }
    }
}
```

### ğŸ”„ è‡ªå‹•åŒ–ã•ã‚ŒãŸå¹´åº¦æœ«å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ 

æ•™è‚²æ©Ÿé–¢ã§ã¯å¹´åº¦æœ«ï¼ˆ3æœˆï¼‰ã«å¤§è¦æ¨¡ãªã‚°ãƒ«ãƒ¼ãƒ—å†ç·¨ãŒå¿…è¦ã§ã™ã€‚ã“ã®ä½œæ¥­ã‚’è‡ªå‹•åŒ–ã™ã‚‹ã“ã¨ã§ã€ç®¡ç†è² è·ã‚’å¤§å¹…ã«å‰Šæ¸›ã§ãã¾ã™ã€‚

#### ğŸ“… å¹´åº¦æœ«å‡¦ç†ã®å…¨ä½“ãƒ•ãƒ­ãƒ¼

```mermaid
graph TD
    A[2æœˆä¸­æ—¬: æº–å‚™ãƒ•ã‚§ãƒ¼ã‚º] --> B[3æœˆä¸Šæ—¬: ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—]
    B --> C[3æœˆä¸­æ—¬: å’æ¥­å‡¦ç†]
    C --> D[3æœˆä¸‹æ—¬: é€²ç´šå‡¦ç†]
    D --> E[4æœˆä¸Šæ—¬: æ–°å…¥ç”Ÿå¯¾å¿œ]
    E --> F[4æœˆä¸­æ—¬: æ¤œè¨¼ãƒ»èª¿æ•´]
    
    A --> A1[ç¾åœ¨ã®ã‚°ãƒ«ãƒ¼ãƒ—æ£šå¸ã—]
    A --> A2[ä¸è¦ã‚°ãƒ«ãƒ¼ãƒ—ã®ç‰¹å®š]
    A --> A3[å¹´åº¦æœ«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç­–å®š]
    
    C --> C1[3å¹´ç”Ÿã‚°ãƒ«ãƒ¼ãƒ—ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–]
    C --> C2[å’æ¥­ç”Ÿã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ç„¡åŠ¹åŒ–]
    C --> C3[ä¿è­·è€…ã‚°ãƒ«ãƒ¼ãƒ—ã®æ›´æ–°]
    
    D --> D1[1â†’2å¹´ã€2â†’3å¹´ã®é€²ç´šå‡¦ç†]
    D --> D2[æ–°1å¹´ç”Ÿã‚°ãƒ«ãƒ¼ãƒ—ã®æº–å‚™]
    D --> D3[æ•™å“¡é…ç½®å¤‰æ›´ã®åæ˜ ]
```

#### ğŸ¤– å®Œå…¨è‡ªå‹•åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```powershell
# å¹´åº¦æœ«å®Œå…¨è‡ªå‹•å‡¦ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
function Invoke-CompleteYearEndProcessing {
    param(
        [int]$CurrentYear = (Get-Date).Year,
        [switch]$DryRun = $false
    )
    
    $nextYear = $CurrentYear + 1
    $logPath = "C:\Logs\YearEndProcessing_$($CurrentYear)_$(Get-Date -Format 'yyyyMMddHHmm').log"
    
    Start-Transcript -Path $logPath
    
    try {
        Write-Host "ğŸš€ å¹´åº¦æœ«å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™ï¼ˆ$CurrentYear â†’ $nextYearï¼‰" -ForegroundColor Green
        
        # ãƒ•ã‚§ãƒ¼ã‚º1: äº‹å‰ç¢ºèªã¨æº–å‚™
        Write-Host "`nğŸ“‹ ãƒ•ã‚§ãƒ¼ã‚º1: äº‹å‰ç¢ºèª" -ForegroundColor Yellow
        $currentGroups = Get-AllEducationGroups -Year $CurrentYear
        Write-Host "å¯¾è±¡ã‚°ãƒ«ãƒ¼ãƒ—æ•°: $($currentGroups.Count)"
        
        # ãƒ•ã‚§ãƒ¼ã‚º2: ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
        Write-Host "`nğŸ’¾ ãƒ•ã‚§ãƒ¼ã‚º2: ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—" -ForegroundColor Yellow
        if (-not $DryRun) {
            Backup-GroupData -Groups $currentGroups -BackupPath "C:\Backup\Groups_$CurrentYear"
        }
        
        # ãƒ•ã‚§ãƒ¼ã‚º3: å’æ¥­å‡¦ç†
        Write-Host "`nğŸ“ ãƒ•ã‚§ãƒ¼ã‚º3: å’æ¥­å‡¦ç†" -ForegroundColor Yellow
        $graduationGroups = $currentGroups | Where-Object {$_.DisplayName -like "*3å¹´*" -or $_.DisplayName -like "*GRADE3*"}
        Process-GraduationGroups -Groups $graduationGroups -DryRun:$DryRun
        
        # ãƒ•ã‚§ãƒ¼ã‚º4: é€²ç´šå‡¦ç†
        Write-Host "`nâ¬†ï¸ ãƒ•ã‚§ãƒ¼ã‚º4: é€²ç´šå‡¦ç†" -ForegroundColor Yellow
        Process-GradePromotion -CurrentYear $CurrentYear -NextYear $nextYear -DryRun:$DryRun
        
        # ãƒ•ã‚§ãƒ¼ã‚º5: æ–°å…¥ç”Ÿæº–å‚™
        Write-Host "`nğŸ†• ãƒ•ã‚§ãƒ¼ã‚º5: æ–°å…¥ç”Ÿã‚°ãƒ«ãƒ¼ãƒ—æº–å‚™" -ForegroundColor Yellow
        Prepare-NewStudentGroups -Year $nextYear -DryRun:$DryRun
        
        # ãƒ•ã‚§ãƒ¼ã‚º6: æ•™å“¡é…ç½®æ›´æ–°
        Write-Host "`nğŸ‘¨â€ğŸ« ãƒ•ã‚§ãƒ¼ã‚º6: æ•™å“¡é…ç½®æ›´æ–°" -ForegroundColor Yellow
        Update-TeacherAssignments -Year $nextYear -DryRun:$DryRun
        
        # ãƒ•ã‚§ãƒ¼ã‚º7: æ¤œè¨¼ã¨å ±å‘Š
        Write-Host "`nâœ… ãƒ•ã‚§ãƒ¼ã‚º7: æ¤œè¨¼ã¨å ±å‘Š" -ForegroundColor Yellow
        $report = Generate-YearEndReport -OldYear $CurrentYear -NewYear $nextYear
        
        Write-Host "`nğŸ‰ å¹´åº¦æœ«å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼" -ForegroundColor Green
        
    } catch {
        Write-Error "å¹´åº¦æœ«å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: $($_.Exception.Message)"
        Send-AlertNotification -Subject "å¹´åº¦æœ«å‡¦ç†ã‚¨ãƒ©ãƒ¼" -Message $_.Exception.Message
    } finally {
        Stop-Transcript
        Send-CompletionReport -LogPath $logPath -Report $report
    }
}

# æ•™è‚²ã‚°ãƒ«ãƒ¼ãƒ—ã®å–å¾—
function Get-AllEducationGroups {
    param([int]$Year)
    
    $educationPrefixes = @("CLASS_", "SUBJECT_", "CLUB_", "COMMITTEE_", "STAFF_", "PROJECT_", "PARENT_")
    $allGroups = @()
    
    foreach ($prefix in $educationPrefixes) {
        $groups = Get-MgGroup -Filter "startswith(displayName, '$prefix')" -All
        $yearGroups = $groups | Where-Object {$_.DisplayName -like "*$Year*"}
        $allGroups += $yearGroups
    }
    
    return $allGroups
}

# å’æ¥­ã‚°ãƒ«ãƒ¼ãƒ—å‡¦ç†
function Process-GraduationGroups {
    param(
        [array]$Groups,
        [switch]$DryRun
    )
    
    foreach ($group in $Groups) {
        Write-Host "ğŸ“ å’æ¥­å‡¦ç†: $($group.DisplayName)"
        
        if (-not $DryRun) {
            # ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ¢ãƒ¼ãƒ‰ã«è¨­å®š
            $archiveName = $group.DisplayName + "_GRADUATED"
            Update-MgGroup -GroupId $group.Id -DisplayName $archiveName -Description "å’æ¥­ã«ã‚ˆã‚Šçµ‚äº† - $(Get-Date -Format 'yyyyå¹´MMæœˆddæ—¥')"
            
            # Teamsãƒãƒ¼ãƒ ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
            try {
                $team = Get-MgTeam -TeamId $group.Id -ErrorAction SilentlyContinue
                if ($team) {
                    # Teams ã‚¢ãƒ¼ã‚«ã‚¤ãƒ– APIï¼ˆå®Ÿè£…ä¾‹ï¼‰
                    Invoke-MgArchiveTeam -TeamId $group.Id
                    Write-Host "  âœ… Teamsãƒãƒ¼ãƒ ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¾ã—ãŸ"
                }
            } catch {
                Write-Host "  âš ï¸ Teamsã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã«å¤±æ•—: $($_.Exception.Message)"
            }
            
            # SharePointã‚µã‚¤ãƒˆã®èª­ã¿å–ã‚Šå°‚ç”¨è¨­å®š
            Set-SharePointSiteReadOnly -GroupId $group.Id
        }
    }
}

# é€²ç´šå‡¦ç†
function Process-GradePromotion {
    param(
        [int]$CurrentYear,
        [int]$NextYear,
        [switch]$DryRun
    )
    
    $promotionMap = @{
        "1å¹´" = "2å¹´"
        "2å¹´" = "3å¹´"
        "GRADE1" = "GRADE2"
        "GRADE2" = "GRADE3"
    }
    
    foreach ($oldGrade in $promotionMap.Keys) {
        $newGrade = $promotionMap[$oldGrade]
        
        $gradeGroups = Get-MgGroup -Filter "contains(displayName, '$oldGrade') and contains(displayName, '$CurrentYear')" -All
        
        foreach ($group in $gradeGroups) {
            Write-Host "â¬†ï¸ é€²ç´šå‡¦ç†: $($group.DisplayName)"
            
            if (-not $DryRun) {
                # æ–°ã—ã„ã‚°ãƒ«ãƒ¼ãƒ—åã®ç”Ÿæˆ
                $newName = $group.DisplayName -replace $oldGrade, $newGrade
                $newName = $newName -replace $CurrentYear, $NextYear
                
                # æ–°å¹´åº¦ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ
                $newGroupParams = @{
                    DisplayName = $newName
                    MailNickname = $group.MailNickname -replace $CurrentYear, $NextYear
                    Description = $group.Description -replace $CurrentYear, $NextYear
                    GroupTypes = $group.GroupTypes
                    MailEnabled = $group.MailEnabled
                    SecurityEnabled = $group.SecurityEnabled
                    Visibility = $group.Visibility
                }
                
                $newGroup = New-MgGroup @newGroupParams
                
                # ã‚ªãƒ¼ãƒŠãƒ¼ã®å¼•ãç¶™ã
                $owners = Get-MgGroupOwner -GroupId $group.Id
                foreach ($owner in $owners) {
                    New-MgGroupOwner -GroupId $newGroup.Id -DirectoryObjectId $owner.Id
                }
                
                # Teamsãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®é©ç”¨
                if ($group.GroupTypes -contains "Unified") {
                    New-MgTeam -GroupId $newGroup.Id -BodyParameter @{
                        "template@odata.bind" = "https://graph.microsoft.com/v1.0/teamsTemplates('educationClass')"
                    }
                }
                
                Write-Host "  âœ… æ–°å¹´åº¦ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆ: $newName"
            }
        }
    }
}

# æ–°å…¥ç”Ÿã‚°ãƒ«ãƒ¼ãƒ—æº–å‚™
function Prepare-NewStudentGroups {
    param(
        [int]$Year,
        [switch]$DryRun
    )
    
    $newStudentGroups = @(
        @{Name = "CLASS_1A_HOMEROOM_$Year"; Description = "1å¹´Açµ„ãƒ›ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ "},
        @{Name = "CLASS_1B_HOMEROOM_$Year"; Description = "1å¹´Bçµ„ãƒ›ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ "},
        @{Name = "CLASS_1C_HOMEROOM_$Year"; Description = "1å¹´Cçµ„ãƒ›ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ "},
        @{Name = "SUBJECT_MATH_GRADE1_$Year"; Description = "1å¹´ç”Ÿæ•°å­¦"},
        @{Name = "SUBJECT_ENGLISH_GRADE1_$Year"; Description = "1å¹´ç”Ÿè‹±èª"}
    )
    
    foreach ($groupTemplate in $newStudentGroups) {
        Write-Host "ğŸ†• æ–°å…¥ç”Ÿã‚°ãƒ«ãƒ¼ãƒ—æº–å‚™: $($groupTemplate.Name)"
        
        if (-not $DryRun) {
            $groupParams = @{
                DisplayName = $groupTemplate.Name
                MailNickname = $groupTemplate.Name.ToLower() -replace "_", "-"
                Description = $groupTemplate.Description
                GroupTypes = @("Unified")
                MailEnabled = $true
                SecurityEnabled = $false
                Visibility = "Private"
            }
            
            $newGroup = New-MgGroup @groupParams
            
            # åŸºæœ¬ãƒãƒ£ãƒ³ãƒãƒ«ã®è¨­å®š
            New-MgTeam -GroupId $newGroup.Id -BodyParameter @{
                "template@odata.bind" = "https://graph.microsoft.com/v1.0/teamsTemplates('educationClass')"
            }
            
            Write-Host "  âœ… ä½œæˆå®Œäº†: $($groupTemplate.Name)"
        }
    }
}

# æ•™å“¡é…ç½®æ›´æ–°
function Update-TeacherAssignments {
    param(
        [int]$Year,
        [switch]$DryRun
    )
    
    # CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æ–°å¹´åº¦ã®æ•™å“¡é…ç½®ã‚’èª­ã¿è¾¼ã¿
    $assignmentFile = "C:\Config\TeacherAssignments_$Year.csv"
    
    if (Test-Path $assignmentFile) {
        $assignments = Import-Csv $assignmentFile
        
        foreach ($assignment in $assignments) {
            Write-Host "ğŸ‘¨â€ğŸ« æ•™å“¡é…ç½®æ›´æ–°: $($assignment.Teacher) â†’ $($assignment.Group)"
            
            if (-not $DryRun) {
                $teacher = Get-MgUser -Filter "userPrincipalName eq '$($assignment.Teacher)'"
                $group = Get-MgGroup -Filter "displayName eq '$($assignment.Group)'"
                
                if ($teacher -and $group) {
                    # å½¹å‰²ã«å¿œã˜ãŸæ¨©é™è¨­å®š
                    if ($assignment.Role -eq "Owner") {
                        New-MgGroupOwner -GroupId $group.Id -DirectoryObjectId $teacher.Id
                    } else {
                        New-MgGroupMember -GroupId $group.Id -DirectoryObjectId $teacher.Id
                    }
                    
                    Write-Host "  âœ… é…ç½®å®Œäº†"
                } else {
                    Write-Host "  âš ï¸ æ•™å“¡ã¾ãŸã¯ã‚°ãƒ«ãƒ¼ãƒ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
                }
            }
        }
    } else {
        Write-Host "âš ï¸ æ•™å“¡é…ç½®ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $assignmentFile"
    }
}

# å¹´åº¦æœ«ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
function Generate-YearEndReport {
    param(
        [int]$OldYear,
        [int]$NewYear
    )
    
    $report = @{
        ProcessDate = Get-Date
        OldYear = $OldYear
        NewYear = $NewYear
        ArchivedGroups = @()
        CreatedGroups = @()
        Errors = @()
        Summary = @{}
    }
    
    # ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã•ã‚ŒãŸã‚°ãƒ«ãƒ¼ãƒ—ã®é›†è¨ˆ
    $archivedGroups = Get-MgGroup -Filter "contains(displayName, 'ARCHIVED') or contains(displayName, 'GRADUATED')" -All
    $report.ArchivedGroups = $archivedGroups.Count
    
    # æ–°è¦ä½œæˆã•ã‚ŒãŸã‚°ãƒ«ãƒ¼ãƒ—ã®é›†è¨ˆ
    $newGroups = Get-MgGroup -Filter "contains(displayName, '$NewYear')" -All
    $report.CreatedGroups = $newGroups.Count
    
    # ã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ
    $report.Summary = @{
        TotalProcessed = $archivedGroups.Count + $newGroups.Count
        Success = $true
        Duration = "å‡¦ç†æ™‚é–“ã‚’è¨ˆç®—"
    }
    
    # ãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›
    $reportPath = "C:\Reports\YearEndReport_$($OldYear)to$($NewYear)_$(Get-Date -Format 'yyyyMMdd').json"
    $report | ConvertTo-Json -Depth 3 | Out-File -FilePath $reportPath -Encoding UTF8
    
    return $report
}

# è‡ªå‹•å®Ÿè¡Œè¨­å®šï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ã‚¹ã‚¯ï¼‰
function Register-YearEndScheduledTask {
    param(
        [datetime]$ExecutionDate = [datetime]"2025/03/15 02:00:00"
    )
    
    $action = New-ScheduledTaskAction -Execute "PowerShell.exe" -Argument "-File C:\Scripts\YearEndProcessing.ps1"
    $trigger = New-ScheduledTaskTrigger -Once -At $ExecutionDate
    $settings = New-ScheduledTaskSettingsSet -ExecutionTimeLimit (New-TimeSpan -Hours 4)
    
    Register-ScheduledTask -TaskName "Microsoft365YearEndProcessing" -Action $action -Trigger $trigger -Settings $settings -User "SYSTEM"
    
    Write-Host "âœ… å¹´åº¦æœ«å‡¦ç†ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ã‚¹ã‚¯ãŒç™»éŒ²ã•ã‚Œã¾ã—ãŸ: $ExecutionDate"
}
```

## ğŸš¨ é«˜åº¦ãªãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ğŸ” è¨ºæ–­ãƒ„ãƒ¼ãƒ«ã¨å•é¡Œè§£æ±º

#### ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆå•é¡Œã®è¨ºæ–­ãƒ„ãƒ¼ãƒ«

```powershell
# åŒ…æ‹¬çš„ãªã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆå•é¡Œè¨ºæ–­ãƒ„ãƒ¼ãƒ«
function Test-GroupCreationIssues {
    param(
        [string]$UserPrincipalName,
        [string]$GroupName = ""
    )
    
    Write-Host "ğŸ” ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆå•é¡Œã®è¨ºæ–­ã‚’é–‹å§‹ã—ã¾ã™..." -ForegroundColor Blue
    Write-Host "å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼: $UserPrincipalName`n" -ForegroundColor Cyan
    
    $diagnostics = @{}
    
    # 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼å­˜åœ¨ç¢ºèª
    try {
        $user = Get-MgUser -Filter "userPrincipalName eq '$UserPrincipalName'"
        if ($user) {
            $diagnostics.UserExists = @{Status = "âœ… OK"; Details = "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã—ã¾ã™"}
            $diagnostics.UserType = @{Status = "ğŸ“‹ æƒ…å ±"; Details = "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ã‚¤ãƒ—: $($user.UserType)"}
            $diagnostics.UserLicense = @{Status = "ğŸ“‹ æƒ…å ±"; Details = "ãƒ©ã‚¤ã‚»ãƒ³ã‚¹: $($user.AssignedLicenses.Count) ä»¶"}
        } else {
            $diagnostics.UserExists = @{Status = "âŒ ã‚¨ãƒ©ãƒ¼"; Details = "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"}
            return $diagnostics
        }
    } catch {
        $diagnostics.UserExists = @{Status = "âŒ ã‚¨ãƒ©ãƒ¼"; Details = "ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼: $($_.Exception.Message)"}
        return $diagnostics
    }
    
    # 2. ãƒ†ãƒŠãƒ³ãƒˆè¨­å®šç¢ºèª
    try {
        $tenantSettings = Get-MgDirectorySetting | Where-Object {$_.DisplayName -eq "Group.Unified"}
        if ($tenantSettings) {
            $enableCreation = ($tenantSettings.Values | Where-Object {$_.Name -eq "EnableGroupCreation"}).Value
            $allowedGroupId = ($tenantSettings.Values | Where-Object {$_.Name -eq "GroupCreationAllowedGroupId"}).Value
            
            if ($enableCreation -eq "false") {
                $diagnostics.TenantSettings = @{Status = "ğŸš« åˆ¶é™"; Details = "ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™"}
                
                if ($allowedGroupId) {
                    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨±å¯ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ¡ãƒ³ãƒãƒ¼ã‹ãƒã‚§ãƒƒã‚¯
                    $isMember = Get-MgGroupMember -GroupId $allowedGroupId | Where-Object {$_.Id -eq $user.Id}
                    if ($isMember) {
                        $diagnostics.UserPermission = @{Status = "âœ… OK"; Details = "è¨±å¯ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ¡ãƒ³ãƒãƒ¼ã§ã™"}
                    } else {
                        $diagnostics.UserPermission = @{Status = "âŒ æ¨©é™ä¸è¶³"; Details = "è¨±å¯ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ¡ãƒ³ãƒãƒ¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“"}
                    }
                } else {
                    $diagnostics.UserPermission = @{Status = "âŒ æ¨©é™ä¸è¶³"; Details = "ç®¡ç†è€…ã®ã¿ãŒã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆå¯èƒ½ã§ã™"}
                }
            } else {
                $diagnostics.TenantSettings = @{Status = "âœ… OK"; Details = "å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆå¯èƒ½"}
                $diagnostics.UserPermission = @{Status = "âœ… OK"; Details = "ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆæ¨©é™ãŒã‚ã‚Šã¾ã™"}
            }
        } else {
            $diagnostics.TenantSettings = @{Status = "âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ"; Details = "åˆ¶é™ãªã—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šï¼‰"}
            $diagnostics.UserPermission = @{Status = "âœ… OK"; Details = "ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆæ¨©é™ãŒã‚ã‚Šã¾ã™"}
        }
    } catch {
        $diagnostics.TenantSettings = @{Status = "âŒ ã‚¨ãƒ©ãƒ¼"; Details = "ãƒ†ãƒŠãƒ³ãƒˆè¨­å®šå–å¾—ã‚¨ãƒ©ãƒ¼: $($_.Exception.Message)"}
    }
    
    # 3. ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ç¢ºèª
    $userLicenses = Get-MgUserLicenseDetail -UserId $user.Id
    $hasOffice365License = $userLicenses | Where-Object {$_.ServicePlans.ServicePlanName -contains "EXCHANGE_S_STANDARD" -or $_.ServicePlans.ServicePlanName -contains "EXCHANGE_S_ENTERPRISE"}
    
    if ($hasOffice365License) {
        $diagnostics.LicenseCheck = @{Status = "âœ… OK"; Details = "å¿…è¦ãªãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã¾ã™"}
    } else {
        $diagnostics.LicenseCheck = @{Status = "âš ï¸ è­¦å‘Š"; Details = "Exchange Onlineãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"}
    }
    
    # 4. å‘½åè¦å‰‡ãƒã‚§ãƒƒã‚¯ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—åãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
    if ($GroupName) {
        $namingPolicy = ($tenantSettings.Values | Where-Object {$_.Name -eq "PrefixSuffixNamingRequirement"}).Value
        $blockedWords = ($tenantSettings.Values | Where-Object {$_.Name -eq "CustomBlockedWordsList"}).Value
        
        if ($namingPolicy -and $GroupName -notmatch $namingPolicy) {
            $diagnostics.NamingPolicy = @{Status = "âŒ é•å"; Details = "å‘½åè¦å‰‡ã«é•å: $namingPolicy"}
        } else {
            $diagnostics.NamingPolicy = @{Status = "âœ… OK"; Details = "å‘½åè¦å‰‡ã«æº–æ‹ "}
        }
        
        if ($blockedWords) {
            $blockedList = $blockedWords -split ","
            $foundBlocked = $blockedList | Where-Object {$GroupName -like "*$_*"}
            if ($foundBlocked) {
                $diagnostics.BlockedWords = @{Status = "âŒ é•å"; Details = "ç¦æ­¢èªå¥ã‚’å«ã‚“ã§ã„ã¾ã™: $($foundBlocked -join ', ')"}
            } else {
                $diagnostics.BlockedWords = @{Status = "âœ… OK"; Details = "ç¦æ­¢èªå¥ã¯å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“"}
            }
        }
    }
    
    # 5. APIåˆ¶é™ç¢ºèª
    try {
        $testQuery = Get-MgGroup -Top 1 -ErrorAction Stop
        $diagnostics.APIAccess = @{Status = "âœ… OK"; Details = "Microsoft Graph APIã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½"}
    } catch {
        if ($_.Exception.Message -like "*throttled*" -or $_.Exception.Message -like "*429*") {
            $diagnostics.APIAccess = @{Status = "âš ï¸ åˆ¶é™"; Details = "APIåˆ¶é™ã«é”ã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„"}
        } else {
            $diagnostics.APIAccess = @{Status = "âŒ ã‚¨ãƒ©ãƒ¼"; Details = "APIæ¥ç¶šã‚¨ãƒ©ãƒ¼: $($_.Exception.Message)"}
        }
    }
    
    # çµæœè¡¨ç¤º
    Write-Host "`nğŸ“Š è¨ºæ–­çµæœ:" -ForegroundColor Green
    Write-Host "=" * 60
    
    foreach ($check in $diagnostics.GetEnumerator()) {
        Write-Host "$($check.Value.Status) $($check.Key): $($check.Value.Details)"
    }
    
    Write-Host "=" * 60
    
    # ä¿®å¾©ææ¡ˆ
    Write-Host "`nğŸ’¡ ä¿®å¾©ææ¡ˆ:" -ForegroundColor Magenta
    if ($diagnostics.UserPermission.Status -like "*æ¨©é™ä¸è¶³*") {
        Write-Host "â€¢ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¨±å¯ã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ ã™ã‚‹ã‹ã€ç®¡ç†è€…ã«ä¾é ¼ã—ã¦ãã ã•ã„"
        Write-Host "  ã‚³ãƒãƒ³ãƒ‰ä¾‹: New-MgGroupMember -GroupId [è¨±å¯ã‚°ãƒ«ãƒ¼ãƒ—ID] -DirectoryObjectId $($user.Id)"
    }
    
    if ($diagnostics.LicenseCheck.Status -like "*è­¦å‘Š*") {
        Write-Host "â€¢ Exchange Onlineã¾ãŸã¯Microsoft 365ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚’å‰²ã‚Šå½“ã¦ã¦ãã ã•ã„"
    }
    
    if ($diagnostics.NamingPolicy.Status -like "*é•å*") {
        Write-Host "â€¢ ã‚°ãƒ«ãƒ¼ãƒ—åã‚’å‘½åè¦å‰‡ã«å¾“ã£ã¦ä¿®æ­£ã—ã¦ãã ã•ã„"
    }
    
    return $diagnostics
}
```

#### Teamsé–¢é€£å•é¡Œã®è¨ºæ–­

```powershell
# Teamsçµ±åˆå•é¡Œã®è¨ºæ–­ãƒ„ãƒ¼ãƒ«
function Test-TeamsIntegrationIssues {
    param(
        [string]$GroupId
    )
    
    Write-Host "ğŸ” Teamsçµ±åˆå•é¡Œã®è¨ºæ–­ã‚’é–‹å§‹ã—ã¾ã™..." -ForegroundColor Blue
    
    try {
        # 1. ã‚°ãƒ«ãƒ¼ãƒ—å­˜åœ¨ç¢ºèª
        $group = Get-MgGroup -GroupId $GroupId
        Write-Host "âœ… ã‚°ãƒ«ãƒ¼ãƒ—ãŒå­˜åœ¨ã—ã¾ã™: $($group.DisplayName)"
        
        # 2. ã‚°ãƒ«ãƒ¼ãƒ—ã‚¿ã‚¤ãƒ—ç¢ºèª
        if ($group.GroupTypes -contains "Unified") {
            Write-Host "âœ… Microsoft 365ã‚°ãƒ«ãƒ¼ãƒ—ã§ã™"
        } else {
            Write-Host "âŒ Microsoft 365ã‚°ãƒ«ãƒ¼ãƒ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆTeamsãƒãƒ¼ãƒ åŒ–ä¸å¯ï¼‰"
            return
        }
        
        # 3. TeamsçŠ¶æ…‹ç¢ºèª
        try {
            $team = Get-MgTeam -TeamId $GroupId -ErrorAction Stop
            Write-Host "âœ… Teamsãƒãƒ¼ãƒ ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™"
            
            # ãƒãƒ¼ãƒ è¨­å®šã®è©³ç´°ç¢ºèª
            Write-Host "ğŸ“‹ ãƒãƒ¼ãƒ è¨­å®š:"
            Write-Host "  - è¡¨ç¤ºå: $($team.DisplayName)"
            Write-Host "  - èª¬æ˜: $($team.Description)"
            Write-Host "  - å¯è¦–æ€§: $($team.Visibility)"
            
            # ãƒãƒ£ãƒ³ãƒãƒ«ç¢ºèª
            $